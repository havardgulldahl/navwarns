name: Interpret NavWarns

on:
  workflow_run:
    workflows: ["Fetch NavWarns"]
    types: [completed]
  workflow_dispatch:

jobs:
  list_navwarns:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.collect.outputs.files }}
    steps:
      - uses: actions/checkout@v5

      - id: collect
        run: |
          files=$(ls current/navwarns/*.json | jq -R -s -c 'split("\n")[:-1]')
          {
            echo "files=$files"
          } >> "$GITHUB_OUTPUT"

  interpret_navwarns:
    needs: list_navwarns
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJSON(needs.list_navwarns.outputs.files) }}
      max-parallel: 2
    permissions:
      contents: write
      models: read

    steps:
      - uses: actions/checkout@v5

      - name: Random sleep to stagger API calls
        run: |
          delay=$((RANDOM % 20 + 5)) # sleep 5â€“25 seconds
          echo "Sleeping $delay seconds..."
          sleep $delay

      - name: Extract body from GeoJSON properties and store in a variable
        id: navwarn_body
        run: |
          geojson=$(jq -r '.properties.body | gsub("\n"; " ")' "${{ matrix.file }}")
          echo "geojson=$geojson" >> "$GITHUB_OUTPUT"

      - name: Run AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: gpt-4.1
          prompt-file: coordinates.prompt.yml
          max-tokens: 1024
          input: |
            navwarn: |
              ${{ steps.navwarn_body.outputs.geojson }}


      - name: Join inferred coordinates with original GeoJSON
        run: |
          base=$(basename "${{ matrix.file }}")
          jq --argjson coords "$(cat '${{ steps.inference.outputs.response-file }}')" \
            '.geometry.coordinates = $coords' '${{ matrix.file }}' > "coords_${base}.geojson"
            

      - name: Derive safe artifact name
        id: artifact_name
        run: |
          # Get just the base filename, no path
          filename=$(basename "${{ matrix.file }}")
          # Remove extension (.json, .geojson, etc.)
          safe_name="${filename%.*}"
          # Replace any remaining invalid characters with underscores
          safe_name=$(echo "$safe_name" | sed 's/[^a-zA-Z0-9._-]/_/g')
          echo "safe_name=$safe_name" >> $GITHUB_OUTPUT

      - name: Upload coordinate file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coordinates-${{ steps.artifact_name.outputs.safe_name }}
          path: coords_*.geojson

  commit:
    runs-on: ubuntu-latest
    needs: interpret_navwarns
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Download all coordinate files
        uses: actions/download-artifact@v4
        with:
          path: current/enriched_navwarns
          merge-multiple: true

      - name: Merge all GeoJSONs into FeatureCollection
        run: |
          tree current/enriched_navwarns
          files=$(find current/enriched_navwarns -name '*.geojson') 
          echo $files
          echo ======
          jq -s '{ "type": "FeatureCollection", "features": . }' $files > current/navwarns.geojson

      - name: Commit merged collection
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cp current/navwarns.geojson docs/navwarns.geojson || echo "Copy failed"
          git add docs/navwarns.geojson current/navwarns.geojson
          git commit -m "Update merged NavWarn FeatureCollection" || echo "No changes"
          git push