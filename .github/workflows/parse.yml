name: Interpret NavWarns

on:
  workflow_run:
    workflows: ["Fetch NavWarns"]
    types: [completed]
  workflow_dispatch:

jobs:
  list_navwarns:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.collect.outputs.files }}
    steps:
      - uses: actions/checkout@v5

      - id: collect
        run: |
          files=$(ls current/navwarns/*.json | jq -R -s -c 'split("\n")[:-1]')
          {
            echo "files=$files"
          } >> "$GITHUB_OUTPUT"

  interpret_navwarns:
    needs: list_navwarns
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJSON(needs.list_navwarns.outputs.files) }}
    permissions:
      contents: write
      models: read

    steps:
      - uses: actions/checkout@v5

      - name: Prepare NavWarn file
        id: prepare
        run: |
          {
            set -x
            echo "navwarns<<EOF"
            cat "${{ matrix.file }}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: gpt-4.1
          prompt: |
            You are given a NavWarn bulletin in a GeoJson Feature,
            where the coordinates are not fully interpreted from the body text.  
            Update the Feature with:
            - correct type: "Point" or "Polygon" if coordinates are given
            - geometry: parsed from coordinates  
            - properties: NavWarn text and metadata  
            - properties.summary: a rewritten and simplified version of the NavWarn body text  

            Input NavWarn:
            ${{ steps.prepare.outputs.navwarns }}

      - name: Save GeoJSON output
        run: |
          mkdir -p current/enriched_navwarns
          filename=$(basename "${{ matrix.file }}" .json)
          out="current/enriched_navwarns/${filename}.geojson"
          echo '${{ steps.inference.outputs.response }}' > "$out"

      - name: Commit enriched file
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add current/enriched_navwarns/*.geojson
          git commit -m "Add enriched NavWarn ${{ matrix.file }}" || echo "No changes"
          git push

  collect_navwarns:
    needs: interpret_navwarns
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5

      - name: Merge all GeoJSONs into FeatureCollection
        run: |
          files=$(ls current/enriched_navwarns/*.geojson)
          jq -s '{ "type": "FeatureCollection", "features": . }' $files > current/navwarns.geojson

      - name: Commit merged collection
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cp current/navwarns.geojson docs/navwarns.geojson || echo "Copy failed"
          git add docs/navwarns.geojson current/navwarns.geojson
          git commit -m "Update merged NavWarn FeatureCollection" || echo "No changes"
          git push