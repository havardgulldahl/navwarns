name: Interpret NavWarns

on:
  workflow_run:
    workflows: ["Fetch NavWarns"]
    types: [completed]
  workflow_dispatch:

jobs:
  # Step 1: Collect list of NavWarn files
  list_navwarns:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.collect.outputs.files }}
    steps:
      - uses: actions/checkout@v5

      - id: collect
        run: |
          # Collect all files into a JSON array
          files=$(ls current/navwarns/*.json | jq -R -s -c 'split("\n")[:-1]')
          echo "files=$files" >> $GITHUB_OUTPUT

  # Step 2: Run inference in parallel for each file
  interpret_navwarns:
    needs: list_navwarns
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJSON(needs.list_navwarns.outputs.files) }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
      models: read

    steps:
      - uses: actions/checkout@v5

      - name: Prepare NavWarn file
        id: prepare
        run: |
          echo "navwarns<<EOF" >> $GITHUB_OUTPUT
          cat "${{ matrix.file }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: gpt-4.1
          prompt: |
            You are given a NavWarn bulletin in a GeoJson Feature,
            where the coordinates are not fully interpreted from the body text.  
            Update the Feature with:
            - correct type: "Point" or "Polygon" if coordinates are given
            - geometry: parsed from coordinates  
            - properties: NavWarn text and metadata  
            - properties.summary: a rewritten and simplified version of the NavWarn body text  

            Input NavWarn:
            ${{ steps.prepare.outputs.navwarns }}

      - name: Save GeoJSON output
        run: |
          mkdir -p current/enriched_navwarns
          out="current/enriched_navwarns/'${{ matrix.file }}'
          echo '${{ steps.inference.outputs.response }}' > "$out"

  # Step 3: Aggregate all results into a single FeatureCollection
  collect_navwarns:
    needs: interpret_navwarns
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5

      - name: Merge all GeoJSONs into FeatureCollection
        run: |
          files=$(ls current/enriched_navwarns/*.geojson)
          jq -s '{ "type": "FeatureCollection", "features": . }' $files > current/navwarns.geojson

      - name: Commit merged collection
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cp current/navwarns.geojson docs/navwarns.geojson || echo "Copy failed"
          git add docs/navwarns.geojson current/navwarns.geojson
          git commit -m "Update merged NavWarn FeatureCollection" || echo "No changes"
          git push