name: Interpret NavWarns

on:
  workflow_run:
    workflows: ["Fetch NavWarns"]
    types: [completed]
  workflow_dispatch:

jobs:
  list_navwarns:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.collect.outputs.files }}
    steps:
      - uses: actions/checkout@v5

      - id: collect
        run: |
          files=$(ls current/navwarns/*.json | jq -R -s -c 'split("\n")[:-1]')
          {
            echo "files=$files"
          } >> "$GITHUB_OUTPUT"

  interpret_navwarns:
    needs: list_navwarns
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJSON(needs.list_navwarns.outputs.files) }}
    permissions:
      contents: write
      models: read

    steps:
      - uses: actions/checkout@v5

      - name: Run AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: gpt-4.1
          prompt: |
            You are given a NavWarn bulletin in a GeoJson Feature,
            where the coordinates are not fully interpreted from the body text.  
            Update the Feature with:
            - correct type: "Point" or "Polygon" if coordinates are given
            - geometry: parsed from coordinates  
            - properties: NavWarn text and metadata  
            - properties.summary: a rewritten and simplified version of the NavWarn body text  

            Input NavWarn:
            $(cat ${{ matrix.file }})


      - name: Save GeoJSON output
        run: |
          base=$(basename "${{ matrix.file }}")
          echo '${{ steps.inference.outputs.response }}' | jq . > "enriched_${base}.geojson"

      - name: Upload enriched file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: enriched-files
          path: enriched_*.geojson

  commit:
    runs-on: ubuntu-latest
    needs: interpret_navwarns
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Download all enriched files
        uses: actions/download-artifact@v4
        with:
          name: enriched-files
          path: current/enriched_navwarns

      - name: Merge all GeoJSONs into FeatureCollection
        run: |
          files=$(ls current/enriched_navwarns/*.geojson)
          jq -s '{ "type": "FeatureCollection", "features": . }' $files > current/navwarns.geojson

      - name: Commit merged collection
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cp current/navwarns.geojson docs/navwarns.geojson || echo "Copy failed"
          git add docs/navwarns.geojson current/navwarns.geojson
          git commit -m "Update merged NavWarn FeatureCollection" || echo "No changes"
          git push